Quiero añadir otro módulo, llamado 'Flujo de Caja', y quiero que me crees las tablas en la base de datos respectivas a 'Flujo de Caja'. en dicho módulo se van a cargar los egresos diarios de gastos múltiples. Por ejemplo: 'Pago de Bono de Transporte a Pedro Perez'.
Necesito que en el módulo de 'Flujo de Caja' Agregar, Consultar, Modificar y Eliminar registros de esos movimientos diarios, y que a su vez cada movimiento de gastos o pagos permita al usuario escoger si ese gasto será pagado en Bolívares o en Divisas (Bs ó $), en caso de ser pagado en Bs, se seleccionará en una casilla desplegable a cual de las cuentas bancarias será debitado ese pago. En caso de ser pagado en $, entonces solo se habilitará un campo Imput para colocar la suma que se pagó en Divisas. Cuando sean pagos en Bs. el monto llevará del lado izquierdo el identificador 'Bs' y cuando el pago sea emitido en Dólares, el monto llevará del lado izquierdo el identificador '$'.

Cada movimiento que se ingrese a 'Flujo de Caja' debe registrar automáticamente los siguientes datos:
	- La Fecha en que se está registrando (y podrá ser cambiado en caso de que el usuario necesite hacerlo) en Formato DD/MM/AAAA.
	- Descripción breve del pago que se está emitiendo (Por ejemplo: 'Pago del Seguro Mensual Volkswagen Combi')
	- Instrumento de Pago: Bs. ó $ (Bolívares o Dólares)
		En caso de Seleccionar Bs primero se le permitirá en una casilla de selección escoger de cuál de los bancos será emitido ese pago, luego debe colocar el monto en el campo 'monto', el sistema automáticamente asignará los separadores de miles '.' y el separador de decimales ',' Por ejemplo, si escribo: 1234567800 el sistema automáticamente lo mostrará Bs. 12.345.678,00.
		En caso de Seleccionar $ podrá seleccionar "en una casilla de selección una de las 2 opciones 'EFECTIVO' ó 'TRANSFERENCIA', luego debe colocar el monto en el campo 'monto', el sistema automáticamente asignará los separadores de miles ',' y el 				separador de decimales '.' Por ejemplo, si escribo: 1234500 el sistema automáticamente lo mostrará '$ 12,345.00'
	- Tasa de cambio (el sistema asumirá la última tasa de cambio colocada por el usuario, y éste podrá cambiarla al momento de añadir algún registro en caso de ser necesario).
	- Responsable; persona que autoriza y/o emite el pago. Ejemplo: Antonio Dragone
	- Beneficiario; persona o entidad que recibe el pago. Ejemplo: Isabel Cristina Carrero
Estos registros se cargan normalmente los días Lunes de cada semana, pero podrán ser alimentados también durante cualquier día.
Siempre se guardan los registros anteriormente mencionados.

necesito que me apoyes a crear éste módulo 'Flujo de Caja', que me ayudes a hacer las modificaciones necesarias en la base de datos, que recuerdes hacer las conexiones necesarias desde el archivo 'flujocaja.php' hacia el archivo 'style.ccs' para que mantenga exactamente el mismo estilo de todos sus módulos hermanos, está bien?
===================================================================================================
Quiero otra cosa en el módulo 'flujocaja.php', quiero que cuando esté añadiendo un nuevo registro, cuando seleccione la cuenta bancaria desde la cual voy a emitir el pago (solo en caso de pagos en Bs); si la cuenta bancaria no posee suficiente saldo disponible para cubrir el pago el sistema, coloque el saldo que me muestra en pantalla en color rojo oscuro, negrita y me arroje un aviso de confirmación: "La cuenta seleccionada NO cuenta con suficiente saldo disponible, desea continuar o prefiere cambiarla?" y tres botones pequeños:
'Continuar' para seguir añadiendo el registro con el banco seleccionado.
'Cambiar' para regresar al imput de seleccion y cambiar de banco.
'Cancelar' para cancelar la operación de incluir registro
====================================================================================================
Ok amigo, ahora necesito que en flujo de caja, se coloquen los imputs en el siguiente orden:
1.- Fecha (tal y como está, no cambies nada)
2.- Instrumento: (Que debería decir Instrumento de Pago:) solo corrigue eso, no le modifiques nada más a ese campo.
Divisas método (si $): eso se elimina, no quiero incluir ese campo imput, y necesito eliminarlo luego de la base de datos.
3.- Descripción: (Que debería decir Descripción del Pago:) solo modifica eso y deja lo demás igual a ese campo imput.
4.- Monto: todo en 'monto' déjalo tal y como está, pero cuando el monto sea superior al saldo disponible de la cuenta bancaria que haya sido seleccionada, quiero que muestres un popup indicando "LA CUENTA SELECCIONADA NO CUENTA CON SUFICIENTE SALDO" y al aceptar, el sistema regrese a la casilla de selección de Cuenta Banco para que el usuario escoja otra que si tenga saldo suficiente.
todo lo demás déjalo tal y como está.
===============================================================================================
Todo mejorando, pero te informo algo, cuando quiero "editar" un registro ya guardado, automáticamente me pasa para una pantalla más abajo con los mismos imputs repetidos. Necesito que cuando el usuario seleccione "editar" algún registro, automáticamente me permita editarlo en los mismos campos que ya tengo disponibles en la pantalla principal de 'flujocaja.php' los mismos que uso para incluir nuevos registros, entiendes la idea?

Te paso el archivo 'flujocaja.php' para que le hagas todas las modificaciones necesarias:
modificado en el V7
============================================================================================
Mucho mejor viejo amigo, ahora necesito que me ayudes en otra cosa que olvidé desde el inicio, cada uno de los registros que se crean en 'flujocaja.php' me van a afectar el saldo disponible en la cuenta bancaria que haya sido seleccionada (se resta ese monto del saldo disponible) entiendes la idea? te paso el archivo para que lo modifiques por mi:
modificado en el V8
==============================================================================================
Ok, otra vez el mismo problema. algo está pasando con los separadores de miles y separador de decimales.
Quiero que utilices la configuración que te daré a continuación (ejemplo: 1,250,520.45) para ambas monedas, tanto Bs como $, porque creo que hay unos errores de calculos debido a eso, te paso el 'flujocaja.php' para que tu mismo lo modifiques, y avisame qué otras cosas debo modificar?

modificado en V10
===========================================
por favor amigo querido, quiero que en el módulo 'flujocaja.php' cuando yo coloque manualmente el monto en mi teclado numérico, y escriba el monto (supongamos que el monto sea 1.582,50) si yo escribo con mi pad numérico en el campo monto la siguiente cantidad: '1582.50' automáticamente el sistema reconozca que ese punto que coloqué pertenece al separador de decimales, y me ajuste automáticamente el monto al darle enter (lo coloque como el ejemplo: 1.582,50) está bien?  te voy a pasar de nuevo 'flujocaja.php' para que lo corrijas de nuevo.

<?php
// Archivo: modules/flujocaja.php
// Módulo: Flujo de Caja (forzado formato miles="," y decimal="." para Bs y $)
// Reemplaza tu archivo flujocaja.php por este (haz backup antes).

session_start();
require_once "../config/db.php";

if (!isset($_SESSION['usuario'])) {
    header('Location: ../index.php');
    exit();
}
if (!isset($_SESSION['empresa_id'])) {
    header('Location: ../select_empresa.php');
    exit();
}
$empresa_id = (int) $_SESSION['empresa_id'];
$usuario_id = isset($_SESSION['usuario_id']) ? (int)$_SESSION['usuario_id'] : null;

function ddmmyyyy_to_sql($d) {
    if (strpos($d, '/') !== false) {
        $parts = explode('/', $d);
        if (count($parts) === 3) {
            return sprintf('%04d-%02d-%02d', intval($parts[2]), intval($parts[1]), intval($parts[0]));
        }
    }
    return $d;
}
function sql_to_ddmmyyyy($d) {
    if (!$d) return '';
    $t = strtotime($d);
    return date('d/m/Y', $t);
}
// Keep PHP parsing helpers tolerant: they accept "1.234,56" or "1,234.56" etc.
// We'll receive normalized strings (decimal point '.') from client but parser stays robust.
function parse_monto_bs_from_input($s) {
    $s = trim((string)$s);
    if ($s === '') return 0.0;
    // Remove spaces and NBSP
    $s = str_replace("\xc2\xa0", '', $s);
    $s = str_replace(' ', '', $s);
    // Normalize common inputs:
    // If contains both separators, decide decimal by last occurrence
    if (substr_count($s, ',') > 0 && substr_count($s, '.') > 0) {
        $lastComma = strrpos($s, ',');
        $lastDot = strrpos($s, '.');
        if ($lastComma > $lastDot) { // comma is decimal (e.g. 1.234,56)
            $s = str_replace('.', '', $s);
            $s = str_replace(',', '.', $s);
        } else { // dot is decimal (e.g. 1,234.56)
            $s = str_replace(',', '', $s);
        }
    } elseif (substr_count($s, ',') > 0 && substr_count($s, '.') == 0) {
        // e.g. "1234,56" -> treat comma as decimal
        $s = str_replace(',', '.', $s);
    } else {
        // only dots or numbers, keep as-is
    }
    return floatval($s);
}
function parse_monto_usd_from_input($s) {
    return parse_monto_bs_from_input($s);
}

// Obtener última tasa
$tasa_actual = null;
$res_t = $conn->query("SELECT tasa FROM tasas ORDER BY fecha DESC, id DESC LIMIT 1");
if ($res_t) {
    $r = $res_t->fetch_assoc();
    if ($r && isset($r['tasa'])) $tasa_actual = floatval($r['tasa']);
}

$action = $_GET['action'] ?? '';
$errors = [];

// --- Obtener bancos con saldos para validar cliente-side ---
$bancos = [];
$rb = $conn->prepare("SELECT id, nombre, IFNULL(saldo,0) AS saldo FROM bancos WHERE empresa_id=? ORDER BY nombre");
$rb->bind_param('i', $empresa_id);
$rb->execute();
$resb = $rb->get_result();
while ($row = $resb->fetch_assoc()) $bancos[] = $row;
$rb->close();

// ------------------- CREATE (guardar) -------------------
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['guardar'])) {
    $fecha = ddmmyyyy_to_sql($_POST['fecha'] ?? date('Y-m-d'));
    $descripcion = trim($_POST['descripcion'] ?? '');
    $instrumento = ($_POST['instrumento'] ?? '') === '$' ? '$' : 'Bs';
    $banco_id = null;
    $monto_bs = null;
    $monto_usd = null;
    // tasa: server expects normalized decimal with dot
    $tasa = isset($_POST['tasa']) && strlen($_POST['tasa'])>0 ? floatval(str_replace(',', '.', $_POST['tasa'])) : $tasa_actual;
    $responsable = trim($_POST['responsable'] ?? '');
    $beneficiario = trim($_POST['beneficiario'] ?? '');

    if ($instrumento === 'Bs') {
        $banco_id = isset($_POST['banco_id']) && $_POST['banco_id'] !== '' ? (int)$_POST['banco_id'] : null;
        $monto_bs = isset($_POST['monto']) ? parse_monto_bs_from_input($_POST['monto']) : 0.0;
        if ($banco_id === null) $errors[] = "Debe seleccionar la cuenta bancaria de donde se debitará el pago en Bs.";
    } else {
        $monto_usd = isset($_POST['monto']) ? parse_monto_usd_from_input($_POST['monto']) : 0.0;
    }

    if ($descripcion === '') $errors[] = "Descripción requerida.";

    if (empty($errors)) {
        // Usar transacción para insertar y actualizar saldo de banco de forma atómica
        $conn->begin_transaction();
        try {
            // Si es Bs, bloquear fila del banco y verificar saldo suficiente
            if ($instrumento === 'Bs' && $banco_id !== null) {
                $qb = $conn->prepare("SELECT IFNULL(saldo,0) FROM bancos WHERE id=? AND empresa_id=? FOR UPDATE");
                $qb->bind_param('ii', $banco_id, $empresa_id);
                $qb->execute();
                $qb->bind_result($bank_saldo_db);
                $qb->fetch();
                $qb->close();
                if ($monto_bs > floatval($bank_saldo_db)) {
                    // saldo insuficiente -> rollback y error
                    $conn->rollback();
                    $errors[] = "La cuenta seleccionada NO cuenta con saldo suficiente (" . number_format(floatval($bank_saldo_db),2,',','.') . " Bs). Cambie la cuenta o ajuste el monto.";
                }
            }

            if (empty($errors)) {
                // Insertar el registro
                $stmt = $conn->prepare("INSERT INTO flujo_caja (empresa_id, fecha, descripcion, instrumento, banco_id, monto_bs, monto_usd, tasa, responsable, beneficiario, creado_por) VALUES (?,?,?,?,?,?,?,?,?,?,?)");
                if (!$stmt) throw new Exception("Error de preparación: " . $conn->error);
                $stmt->bind_param("isssidddssi", $empresa_id, $fecha, $descripcion, $instrumento, $banco_id, $monto_bs, $monto_usd, $tasa, $responsable, $beneficiario, $usuario_id);
                if (!$stmt->execute()) {
                    $err = $stmt->error;
                    $stmt->close();
                    throw new Exception("Error al guardar: " . $err);
                }
                $stmt->close();

                // Si es Bs, restar monto del saldo de la cuenta (ya verificada)
                if ($instrumento === 'Bs' && $banco_id !== null && $monto_bs > 0) {
                    $qup = $conn->prepare("UPDATE bancos SET saldo = IFNULL(saldo,0) - ? WHERE id = ? AND empresa_id = ?");
                    if (!$qup) throw new Exception("Error preparando actualización de banco: " . $conn->error);
                    $qup->bind_param('dii', $monto_bs, $banco_id, $empresa_id);
                    if (!$qup->execute()) {
                        $err = $qup->error;
                        $qup->close();
                        throw new Exception("Error al actualizar saldo banco: " . $err);
                    }
                    $qup->close();
                }

                $conn->commit();
                $_SESSION['msg'] = "Registro agregado.";
                header("Location: flujocaja.php");
                exit();
            }
        } catch (Exception $ex) {
            $conn->rollback();
            $errors[] = $ex->getMessage();
        }
    }
}

// ------------------- UPDATE (guardar_edicion) -------------------
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['guardar_edicion'])) {
    $id = intval($_POST['id']);
    $fecha = ddmmyyyy_to_sql($_POST['fecha'] ?? date('Y-m-d'));
    $descripcion = trim($_POST['descripcion'] ?? '');
    $instrumento = ($_POST['instrumento'] ?? '') === '$' ? '$' : 'Bs';
    $banco_id = null;
    $monto_bs = null;
    $monto_usd = null;
    $tasa = isset($_POST['tasa']) && strlen($_POST['tasa'])>0 ? floatval(str_replace(',', '.', $_POST['tasa'])) : $tasa_actual;
    $responsable = trim($_POST['responsable'] ?? '');
    $beneficiario = trim($_POST['beneficiario'] ?? '');

    if ($instrumento === 'Bs') {
        $banco_id = isset($_POST['banco_id']) && $_POST['banco_id'] !== '' ? (int)$_POST['banco_id'] : null;
        $monto_bs = isset($_POST['monto']) ? parse_monto_bs_from_input($_POST['monto']) : 0.0;
        if ($banco_id === null) $errors[] = "Debe seleccionar la cuenta bancaria de donde se debitará el pago en Bs.";
    } else {
        $monto_usd = isset($_POST['monto']) ? parse_monto_usd_from_input($_POST['monto']) : 0.0;
    }

    if ($descripcion === '') $errors[] = "Descripción requerida.";

    if (empty($errors)) {
        // Transacción para revertir efecto anterior y aplicar nuevo
        $conn->begin_transaction();
        try {
            // Bloquear y leer la fila existente
            $sr = $conn->prepare("SELECT instrumento, banco_id, IFNULL(monto_bs,0) AS monto_bs, IFNULL(monto_usd,0) AS monto_usd FROM flujo_caja WHERE id=? AND empresa_id=? FOR UPDATE");
            if (!$sr) throw new Exception("Error preparando lectura registro: " . $conn->error);
            $sr->bind_param('ii', $id, $empresa_id);
            $sr->execute();
            $sr->bind_result($old_instrumento, $old_banco_id, $old_monto_bs, $old_monto_usd);
            if (!$sr->fetch()) {
                $sr->close();
                throw new Exception("Registro no encontrado para edición.");
            }
            $sr->close();

            // 1) Revertir efecto anterior sobre bancos (si aplicaba)
            if ($old_instrumento === 'Bs' && $old_banco_id !== null && $old_monto_bs > 0) {
                $qrev = $conn->prepare("UPDATE bancos SET saldo = IFNULL(saldo,0) + ? WHERE id = ? AND empresa_id = ?");
                if (!$qrev) throw new Exception("Error preparando revert banco: " . $conn->error);
                $qrev->bind_param('dii', $old_monto_bs, $old_banco_id, $empresa_id);
                if (!$qrev->execute()) {
                    $err = $qrev->error;
                    $qrev->close();
                    throw new Exception("Error al revertir saldo banco antiguo: " . $err);
                }
                $qrev->close();
            }

            // 2) Si nuevo instrumento es Bs, comprobar saldo (después de la reversión) y descontar
            if ($instrumento === 'Bs' && $banco_id !== null && $monto_bs > 0) {
                // Bloquear banco fila y verificar saldo
                $qb = $conn->prepare("SELECT IFNULL(saldo,0) FROM bancos WHERE id=? AND empresa_id=? FOR UPDATE");
                if (!$qb) throw new Exception("Error preparando select banco: " . $conn->error);
                $qb->bind_param('ii', $banco_id, $empresa_id);
                $qb->execute();
                $qb->bind_result($bank_saldo_db);
                $qb->fetch();
                $qb->close();
                if ($monto_bs > floatval($bank_saldo_db)) {
                    $conn->rollback();
                    $errors[] = "La cuenta seleccionada NO cuenta con saldo suficiente (" . number_format(floatval($bank_saldo_db),2,',','.') . " Bs). Cambie la cuenta o ajuste el monto.";
                } else {
                    // Restar el nuevo monto
                    $qup = $conn->prepare("UPDATE bancos SET saldo = IFNULL(saldo,0) - ? WHERE id = ? AND empresa_id = ?");
                    if (!$qup) throw new Exception("Error preparando actualización de banco: " . $conn->error);
                    $qup->bind_param('dii', $monto_bs, $banco_id, $empresa_id);
                    if (!$qup->execute()) {
                        $err = $qup->error;
                        $qup->close();
                        throw new Exception("Error al actualizar saldo banco nuevo: " . $err);
                    }
                    $qup->close();
                }
            }

            if (empty($errors)) {
                // 3) Actualizar el registro flujo_caja
                $stmt = $conn->prepare("UPDATE flujo_caja SET fecha=?, descripcion=?, instrumento=?, banco_id=?, monto_bs=?, monto_usd=?, tasa=?, responsable=?, beneficiario=?, actualizado_por=?, actualizado_en=NOW() WHERE id=? AND empresa_id=?");
                if (!$stmt) throw new Exception("Error preparando UPDATE registro: " . $conn->error);
                $stmt->bind_param("sssidddssiii", $fecha, $descripcion, $instrumento, $banco_id, $monto_bs, $monto_usd, $tasa, $responsable, $beneficiario, $usuario_id, $id, $empresa_id);
                if (!$stmt->execute()) {
                    $err = $stmt->error;
                    $stmt->close();
                    throw new Exception("Error al actualizar registro: " . $err);
                }
                $stmt->close();

                $conn->commit();
                $_SESSION['msg'] = "Registro actualizado.";
                header("Location: flujocaja.php");
                exit();
            }
        } catch (Exception $ex) {
            $conn->rollback();
            $errors[] = $ex->getMessage();
        }
    }
}

// ------------------- DELETE (eliminar) -------------------
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['eliminar'])) {
    $id = intval($_POST['id']);

    // Transacción: obtener registro y restaurar saldo si era Bs
    $conn->begin_transaction();
    try {
        $sr = $conn->prepare("SELECT instrumento, banco_id, IFNULL(monto_bs,0) AS monto_bs FROM flujo_caja WHERE id=? AND empresa_id=? FOR UPDATE");
        if (!$sr) throw new Exception("Error preparando lectura para eliminar: " . $conn->error);
        $sr->bind_param('ii', $id, $empresa_id);
        $sr->execute();
        $sr->bind_result($del_instrumento, $del_banco_id, $del_monto_bs);
        if (!$sr->fetch()) {
            $sr->close();
            throw new Exception("Registro no encontrado para eliminar.");
        }
        $sr->close();

        if ($del_instrumento === 'Bs' && $del_banco_id !== null && $del_monto_bs > 0) {
            $qup = $conn->prepare("UPDATE bancos SET saldo = IFNULL(saldo,0) + ? WHERE id = ? AND empresa_id = ?");
            if (!$qup) throw new Exception("Error preparando restauración saldo banco: " . $conn->error);
            $qup->bind_param('dii', $del_monto_bs, $del_banco_id, $empresa_id);
            if (!$qup->execute()) {
                $err = $qup->error;
                $qup->close();
                throw new Exception("Error al restaurar saldo banco: " . $err);
            }
            $qup->close();
        }

        $sd = $conn->prepare("DELETE FROM flujo_caja WHERE id=? AND empresa_id=?");
        if (!$sd) throw new Exception("Error preparando DELETE: " . $conn->error);
        $sd->bind_param('ii', $id, $empresa_id);
        if (!$sd->execute()) {
            $err = $sd->error;
            $sd->close();
            throw new Exception("Error al eliminar registro: " . $err);
        }
        $sd->close();

        $conn->commit();
        $_SESSION['msg'] = "Registro eliminado.";
        header("Location: flujocaja.php");
        exit();
    } catch (Exception $ex) {
        $conn->rollback();
        $errors[] = $ex->getMessage();
    }
}

// ------------------- listado/presentación (sin cambios) -------------------
$page = max(1, intval($_GET['page'] ?? 1));
$perpage = 20;
$offset = ($page - 1) * $perpage;
$total_rows = 0;
$res_total = $conn->prepare("SELECT COUNT(*) FROM flujo_caja WHERE empresa_id=?");
$res_total->bind_param('i', $empresa_id);
$res_total->execute();
$res_total->bind_result($total_rows);
$res_total->fetch();
$res_total->close();

$stmt = $conn->prepare("SELECT f.*, b.nombre AS banco_nombre FROM flujo_caja f LEFT JOIN bancos b ON f.banco_id = b.id WHERE f.empresa_id=? ORDER BY f.fecha DESC, f.id DESC LIMIT ? OFFSET ?");
$stmt->bind_param('iii', $empresa_id, $perpage, $offset);
$stmt->execute();
$result = $stmt->get_result();
$items = $result->fetch_all(MYSQLI_ASSOC);
$stmt->close();

$msg_flash = $_SESSION['msg'] ?? '';
unset($_SESSION['msg']);
?>
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Flujo de Caja | <?php echo htmlspecialchars($_SESSION['nombre'] ?? ''); ?></title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="../assets/css/style.css?v=<?php echo time(); ?>">
<style>
/* Ajustes visuales específicos */
.container-dashboard { max-width:1100px; margin:0 auto; padding: 1rem; }
.card-panel { background:var(--color-panel); border-radius:12px; padding:1rem; box-shadow:0 6px 20px var(--color-shadow); margin-bottom:1rem; }
.form-row { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; }
.form-row label { flex:1 1 220px; min-width:180px; display:flex; flex-direction:column; gap:0.35rem; font-weight:600; color:var(--color-titulo); }
.form-row input[type="text"], .form-row input[type="number"], .form-row select { padding:8px 10px; border-radius:8px; border:none; background:var(--color-input-bg); box-shadow:0 1px 4px var(--color-shadow); }
.currency-badge { display:inline-block; min-width:44px; font-weight:bold; text-align:center; padding:6px 8px; border-radius:8px; background:#f0f4fb; color:var(--color-principal); margin-right:6px; }
.table-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
.sr-only { position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
.small-note { font-size:0.88rem; color:#666; margin-top:6px; }

@media (max-width:720px) {
    .form-row label { min-width:100%; }
}
</style>
</head>
<body>
    <nav class="nav-bar">
        <div class="nav-logo"><img src="../assets/img/logo.png" class="nav-logo-img" alt="logo"></div>
        <div class="nav-empresa"><b>Flujo de Caja</b></div>
        <div class="nav-user">
            <button class="btn-volver" onclick="window.location.href='dashboard.php'">Volver</button>
        </div>
    </nav>

    <main class="dashboard-main">
        <div class="container-dashboard">
            <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div>
                    <h2 style="margin:0;">Flujo de Caja</h2>
                    <div class="small-note">Registra los egresos diarios y administra pagos en Bs y en $</div>
                </div>
                <div class="inline-actions no-print">
                    <button class="btn-principal" onclick="document.getElementById('form-nuevo').scrollIntoView({behavior:'smooth'});">Agregar movimiento</button>
                    <a class="btn-volver" href="reportes.php">Ir a Reportes</a>
                </div>
            </header>

            <?php if ($msg_flash): ?>
                <div class="msg-info card-panel"><?php echo htmlspecialchars($msg_flash); ?></div>
            <?php endif; ?>

            <?php if (!empty($errors)): ?>
                <div class="msg card-panel"><?php foreach($errors as $e) echo htmlspecialchars($e)."<br>"; ?></div>
            <?php endif; ?>

            <!-- Formulario principal (servirá para crear y para editar) -->
            <section id="form-nuevo" class="card-panel" aria-label="Agregar movimiento">
                <h3 style="margin-top:0;" id="form-title">Agregar movimiento</h3>
                <form id="form_agregar" method="POST" onsubmit="return flujocaja_before_submit(this);" class="formulario">
                    <!-- hidden id: if set, we are editing -->
                    <input type="hidden" name="id" id="form_id" value="">
                    <div class="form-row">
                        <!-- 1. Fecha (sin cambios) -->
                        <label>Fecha (DD/MM/AAAA):
                            <input name="fecha" id="fecha_input" type="text" value="<?php echo date('d/m/Y'); ?>" required placeholder="DD/MM/AAAA" />
                        </label>

                        <!-- 2. Instrumento (solo etiqueta modificada) -->
                        <label>Instrumento de Pago:
                            <select name="instrumento" id="instrumento" onchange="flujocaja_toggle_instrumento();" required>
                                <option value="Bs">Bolívares (Bs)</option>
                                <option value="$">Dólares ($)</option>
                            </select>
                        </label>
                    </div>

                    <!-- Cuenta banco -->
                    <div class="form-row" style="margin-top:0.6rem;">
                        <label>Cuenta banco (si Bs):
                            <select name="banco_id" id="banco_id" onchange="flujocaja_on_bank_change();">
                                <option value="">-- Seleccione cuenta --</option>
                                <?php foreach($bancos as $b): ?>
                                    <option value="<?php echo $b['id']; ?>" data-saldo="<?php echo htmlspecialchars($b['saldo']); ?>"><?php echo htmlspecialchars($b['nombre']); ?></option>
                                <?php endforeach; ?>
                            </select>
                            <div id="bank_saldo_info" class="small-note" aria-live="polite"></div>
                        </label>
                    </div>

                    <!-- 3. Descripción -->
                    <div class="form-row" style="margin-top:0.6rem;">
                        <label>Descripción del Pago:
                            <input type="text" name="descripcion" id="descripcion_input" placeholder="Ej: Pago de bono de transporte a Pedro Pérez" required />
                        </label>

                        <!-- 4. Monto -->
                        <label>Monto:
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div id="currency_label" class="currency-badge">Bs</div>
                                <input type="text" name="monto" id="monto_input" required placeholder="0" />
                            </div>
                        </label>
                    </div>

                    <div class="form-row" style="margin-top:0.6rem;">
                        <label>Tasa (si desea cambiar):
                            <input type="text" name="tasa" id="tasa_input" value="<?php echo $tasa_actual!==null ? htmlspecialchars(str_replace(',', '.', (string)$tasa_actual)) : ''; ?>" />
                        </label>
                        <label>Responsable:
                            <input type="text" name="responsable" id="responsable_input" />
                        </label>
                        <label>Beneficiario:
                            <input type="text" name="beneficiario" id="beneficiario_input" />
                        </label>
                    </div>

                    <div style="margin-top:0.9rem;">
                        <button type="submit" id="submit_btn" name="guardar" class="btn-principal">Guardar</button>
                        <button type="button" id="cancel_edit_btn" class="btn-volver" style="margin-left:8px;display:none;">Cancelar edición</button>
                        <button type="reset" class="btn-cancelar" style="margin-left:8px;">Limpiar</button>
                    </div>
                </form>
            </section>

            <!-- Listado (sin cambios visuales) -->
            <section style="margin-top:1rem;">
                <h3 style="margin-bottom:10px;">Movimientos recientes</h3>
                <?php if (count($items) === 0): ?>
                    <div class="msg card-panel">No hay movimientos registrados.</div>
                <?php else: ?>
                    <div class="tabla-scroll card-panel">
                        <table class="reporte-tabla" style="width:100%;">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Descripción</th>
                                    <th>Instrumento</th>
                                    <th>Cuenta</th>
                                    <th class="align-right">Monto</th>
                                    <th>Resp.</th>
                                    <th>Benef.</th>
                                    <th class="no-print">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($items as $it):
                                    $data_id = (int)$it['id'];
                                    $data_fecha = htmlspecialchars(sql_to_ddmmyyyy($it['fecha']));
                                    $data_desc = htmlspecialchars($it['descripcion']);
                                    $data_instr = ($it['instrumento'] === '$') ? '$' : 'Bs';
                                    $data_banco = isset($it['banco_id']) ? (int)$it['banco_id'] : '';
                                    $data_monto_bs = isset($it['monto_bs']) ? floatval($it['monto_bs']) : 0;
                                    $data_monto_usd = isset($it['monto_usd']) ? floatval($it['monto_usd']) : 0;
                                    $data_tasa = isset($it['tasa']) ? htmlspecialchars($it['tasa']) : '';
                                    $data_resp = htmlspecialchars($it['responsable']);
                                    $data_ben = htmlspecialchars($it['beneficiario']);
                                ?>
                                    <tr>
                                        <td><?php echo $data_fecha; ?></td>
                                        <td><?php echo $data_desc; ?></td>
                                        <td><?php echo $data_instr; ?></td>
                                        <td><?php echo htmlspecialchars($it['banco_nombre'] ?? '—'); ?></td>
                                        <td class="align-right">
                                            <?php if ($it['instrumento'] === 'Bs'):
                                                $v = floatval($it['monto_bs'] ?? 0.0);
                                            ?>
                                                <span class="amount" data-raw="<?php echo $v; ?>" data-currency="Bs">Bs <?php echo htmlspecialchars(number_format($v, 2, ',', '.')); ?></span>
                                                <?php if ($it['tasa'] && floatval($it['tasa'])>0):
                                                    $usd = $v / floatval($it['tasa']);
                                                ?>
                                                    <div style="font-size:0.85rem;color:#666;">(US$ <?php echo htmlspecialchars(number_format($usd,2,',','.')); ?>)</div>
                                                <?php endif; ?>
                                            <?php else:
                                                $v = floatval($it['monto_usd'] ?? 0.0);
                                            ?>
                                                <span class="amount" data-raw="<?php echo $v; ?>" data-currency="$">$ <?php echo htmlspecialchars(number_format($v,2,',','.')); ?></span>
                                            <?php endif; ?>
                                        </td>
                                        <td><?php echo $data_resp; ?></td>
                                        <td><?php echo $data_ben; ?></td>
                                        <td class="no-print">
                                            <div class="table-actions" aria-label="Acciones">
                                                <a href="#" class="btn-accion editar"
                                                   title="Editar"
                                                   data-id="<?php echo $data_id; ?>"
                                                   data-fecha="<?php echo $data_fecha; ?>"
                                                   data-descripcion="<?php echo $data_desc; ?>"
                                                   data-instrumento="<?php echo $data_instr; ?>"
                                                   data-banco="<?php echo $data_banco; ?>"
                                                   data-montobs="<?php echo $data_monto_bs; ?>"
                                                   data-montousd="<?php echo $data_monto_usd; ?>"
                                                   data-tasa="<?php echo $data_tasa; ?>"
                                                   data-responsable="<?php echo $data_resp; ?>"
                                                   data-beneficiario="<?php echo $data_ben; ?>"
                                                   onclick="loadRecordIntoMainForm(this); return false;">
                                                    <span aria-hidden="true">&#9998;</span>
                                                    <span class="sr-only">Editar</span>
                                                </a>

                                                <form method="POST" style="display:inline;margin:0;" onsubmit="return confirm('¿Eliminar registro?');">
                                                    <input type="hidden" name="id" value="<?php echo $it['id']; ?>">
                                                    <button type="submit" name="eliminar" class="btn-accion eliminar" title="Eliminar">
                                                        <span aria-hidden="true">&#128465;</span>
                                                        <span class="sr-only">Eliminar</span>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>

                    <?php
                        $total_pages = max(1, ceil($total_rows / $perpage));
                    ?>
                    <div style="margin-top:0.8rem;">
                        <?php for ($p = 1; $p <= $total_pages; $p++): ?>
                            <a href="flujocaja.php?page=<?php echo $p; ?>" class="btn-volver" style="margin-right:6px;<?php echo $p==$page?'opacity:0.8;':''; ?>"><?php echo $p; ?></a>
                        <?php endfor; ?>
                    </div>
                <?php endif; ?>
            </section>

        </div>

        <div style="height:120px;"></div>
    </main>

    <!-- Cargar JS al final -->
    <script src="../assets/js/flujocaja.js?v=<?php echo time(); ?>"></script>
    <script>
    // Forzado: usar formato miles = ',' y decimal = '.' (ejemplo: 1,250,520.45)
    // No dependemos de la configuración del navegador: forzamos en esta página.
    const FIXED_LOCALE = 'en-US'; // en-US produce 1,250,520.45
    function nf2_fixed() {
        try {
            return new Intl.NumberFormat(FIXED_LOCALE, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } catch(e) {
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    }
    const NUM_FORMAT = nf2_fixed();

    // Force explicit separators for parsing logic
    const SEPS = { group: ',', decimal: '.' };

    // Format number for display (2 decimals) using fixed format
    function fcj_formatNumber(value) {
        if (value === null || value === undefined || isNaN(Number(value))) return '';
        return NUM_FORMAT.format(Number(value));
    }
    // Currency wrappers
    function fcj_formatBs(value) { return fcj_formatNumber(value); }
    function fcj_formatUsd(value) { return fcj_formatNumber(value); }

    // Unformat string formatted as "1,250,520.45" into normalized "1250520.45"
    function fcj_unformat(str) {
        if (str === null || str === undefined) return '';
        str = String(str).trim();
        if (str === '') return '';
        // Remove NBSP and normal spaces
        str = str.replace(/\u00A0/g,'').replace(/\s/g,'');
        // Remove currency symbols and letters
        str = str.replace(/[^\d\-\.,]/g,'');
        // Remove group separators (commas)
        if (SEPS.group) {
            var gEsc = SEPS.group.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            var reGroup = new RegExp(gEsc, 'g');
            str = str.replace(reGroup, '');
        } else {
            str = str.replace(/[,\u202F\u00A0 ](?=\d{3}($|\D))/g,'');
        }
        // Replace decimal separator with dot (SEPS.decimal is '.')
        if (SEPS.decimal && SEPS.decimal !== '.') {
            var dEsc = SEPS.decimal.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            var reDec = new RegExp(dEsc, 'g');
            str = str.replace(reDec, '.');
        }
        // Remove anything except digits, dot, minus
        str = str.replace(/[^0-9\.\-]/g, '');
        // Normalize multiple dots (keep last dot as decimal)
        var parts = str.split('.');
        if (parts.length > 2) {
            var last = parts.pop();
            str = parts.join('') + '.' + last;
        }
        return str;
    }

    // Expose globally
    window.fcj_formatBs = fcj_formatBs;
    window.fcj_formatUsd = fcj_formatUsd;
    window.fcj_unformat = fcj_unformat;

    // Exponer bancos balances para uso en cliente (raw numbers)
    const BANK_BALANCES = <?php
        $map = [];
        foreach ($bancos as $b) {
            $map[(int)$b['id']] = floatval($b['saldo']);
        }
        echo json_encode($map, JSON_NUMERIC_CHECK);
    ?>;

    // Format all .amount spans on load according to forced format
    function formatAllAmountsOnPage() {
        var nodes = document.querySelectorAll('.amount');
        nodes.forEach(function(el) {
            var raw = el.getAttribute('data-raw');
            var curr = el.getAttribute('data-currency') || '';
            if (raw === null || raw === undefined) return;
            var num = Number(raw);
            if (isNaN(num)) return;
            var formatted = fcj_formatNumber(num);
            if (curr === 'Bs') {
                el.textContent = 'Bs ' + formatted;
            } else if (curr === '$') {
                el.textContent = '$ ' + formatted;
            } else {
                el.textContent = formatted;
            }
        });
    }

    // Helper to safely set select value
    function setSelectValue(sel, val) {
        if (!sel) return;
        try { sel.value = val; } catch(e) {}
    }

    // Load a record (anchor element) into the main form for editing
    function loadRecordIntoMainForm(el) {
        if (!el || !el.dataset) return;
        var id = el.dataset.id || '';
        var fecha = el.dataset.fecha || '';
        var descripcion = el.dataset.descripcion || '';
        var instrumento = el.dataset.instrumento || 'Bs';
        var banco = el.dataset.banco || '';
        var montoBs = el.dataset.montobs || '0';
        var montoUsd = el.dataset.montousd || '0';
        var tasa = el.dataset.tasa || '';
        var responsable = el.dataset.responsable || '';
        var beneficiario = el.dataset.beneficiario || '';

        document.getElementById('form_id').value = id;
        document.getElementById('fecha_input').value = fecha;
        document.getElementById('descripcion_input').value = descripcion;
        if (document.getElementById('tasa_input')) document.getElementById('tasa_input').value = fcj_formatNumber(Number(tasa)||0);
        if (document.getElementById('responsable_input')) document.getElementById('responsable_input').value = responsable;
        if (document.getElementById('beneficiario_input')) document.getElementById('beneficiario_input').value = beneficiario;

        var instrSel = document.getElementById('instrumento');
        if (instrSel) setSelectValue(instrSel, instrumento);
        var badge = document.getElementById('currency_label');
        if (badge) badge.innerText = instrumento === 'Bs' ? 'Bs' : '$';

        var bancoSel = document.getElementById('banco_id');
        if (bancoSel) setSelectValue(bancoSel, banco);

        var montoInput = document.getElementById('monto_input');
        if (montoInput) {
            if (instrumento === 'Bs') montoInput.value = fcj_formatNumber(Number(montoBs)||0);
            else montoInput.value = fcj_formatNumber(Number(montoUsd)||0);
        }

        var submitBtn = document.getElementById('submit_btn');
        if (submitBtn) {
            submitBtn.name = 'guardar_edicion';
            submitBtn.textContent = 'Guardar cambios';
        }
        var cancelBtn = document.getElementById('cancel_edit_btn');
        if (cancelBtn) cancelBtn.style.display = 'inline-block';

        document.getElementById('form-nuevo').scrollIntoView({behavior:'smooth', block:'center'});
        updateBankSaldoInfo(document.getElementById('form_agregar'), 'bank_saldo_info');
        setTimeout(function(){ var desc = document.getElementById('descripcion_input'); if (desc) desc.focus(); }, 200);
    }

    // Cancel edit mode
    document.addEventListener('DOMContentLoaded', function(){
        var cancelBtn = document.getElementById('cancel_edit_btn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function(){
                var form = document.getElementById('form_agregar');
                form.reset();
                document.getElementById('form_id').value = '';
                var submitBtn = document.getElementById('submit_btn');
                if (submitBtn) { submitBtn.name = 'guardar'; submitBtn.textContent = 'Guardar'; }
                this.style.display = 'none';
                if (document.getElementById('currency_label')) document.getElementById('currency_label').innerText = 'Bs';
                updateBankSaldoInfo(document.getElementById('form_agregar'), 'bank_saldo_info');
            });
        }

        // Format all amounts shown on the page using forced format
        formatAllAmountsOnPage();
    });

    // Update the small note that shows balance and mark red if insufficient
    function updateBankSaldoInfo(form, infoId) {
        if (!form) return;
        const bankSel = form.querySelector('select[name="banco_id"]');
        const montoInput = form.querySelector('input[name="monto"]');
        const info = document.getElementById(infoId);
        if (!bankSel || !info) return;
        const bid = bankSel.value ? parseInt(bankSel.value,10) : null;
        if (!bid) { info.innerHTML = ''; bankSel.style.border=''; return; }
        const saldo = BANK_BALANCES[bid] || 0;
        const saldoStr = fcj_formatNumber(saldo);
        let montoRaw = 0;
        if (montoInput) {
            var u = fcj_unformat(montoInput.value);
            montoRaw = u ? parseFloat(u) : 0;
        }
        if (montoRaw > saldo) {
            info.innerHTML = 'Saldo disponible: <span style="font-weight:800;color:#8B0000;">Bs ' + saldoStr + '</span>';
            bankSel.style.border = '2px solid #8B0000';
        } else {
            info.innerHTML = 'Saldo disponible: Bs ' + saldoStr;
            bankSel.style.border = '';
        }
    }

    // If insufficient, show alert and focus bank select
    function maybeCheckInsufficientAndFocus(form) {
        if (!form) return false;
        const instr = form.querySelector('select[name="instrumento"]');
        if (!instr || instr.value !== 'Bs') return false;
        const bankSel = form.querySelector('select[name="banco_id"]');
        if (!bankSel || !bankSel.value) return false;
        const bid = parseInt(bankSel.value, 10);
        const saldo = BANK_BALANCES[bid] || 0;
        const montoInput = form.querySelector('input[name="monto"]');
        if (!montoInput) return false;
        const raw = fcj_unformat(montoInput.value);
        const montoVal = raw ? parseFloat(raw) : 0;
        if (montoVal > saldo) {
            alert("LA CUENTA SELECCIONADA NO CUENTA CON SUFICIENTE SALDO");
            bankSel.focus();
            return true;
        }
        return false;
    }

    // Events on monto input to update bank info and check insufficiency
    document.addEventListener('DOMContentLoaded', function(){
        const monto = document.getElementById('monto_input');
        if (monto) {
            monto.addEventListener('blur', function(){
                var u = fcj_unformat(this.value);
                if (u !== '') {
                    var n = Number(u);
                    this.value = fcj_formatNumber(n);
                }
                updateBankSaldoInfo(document.getElementById('form_agregar'), 'bank_saldo_info');
                maybeCheckInsufficientAndFocus(document.getElementById('form_agregar'));
            });
            monto.addEventListener('keydown', function(e){
                if (e.key === 'Enter') {
                    e.preventDefault();
                    setTimeout(function(){
                        var u = fcj_unformat(monto.value);
                        if (u !== '') monto.value = fcj_formatNumber(Number(u));
                        updateBankSaldoInfo(document.getElementById('form_agregar'), 'bank_saldo_info');
                        maybeCheckInsufficientAndFocus(document.getElementById('form_agregar'));
                    }, 50);
                }
            });
        }
    });

    function flujocaja_on_bank_change() {
        const form = document.getElementById('form_agregar');
        updateBankSaldoInfo(form, 'bank_saldo_info');
    }

    function flujocaja_toggle_instrumento(){
        var instr = document.getElementById('instrumento').value;
        var banco = document.getElementById('banco_id');
        var label = document.getElementById('currency_label');
        var monto = document.getElementById('monto_input');
        if(instr === 'Bs'){
            banco.disabled = false;
            label.innerText = 'Bs';
            if (monto) monto.placeholder = '0';
        } else {
            banco.disabled = true;
            banco.value = '';
            label.innerText = '$';
            if (monto) monto.placeholder = '0';
            var info = document.getElementById('bank_saldo_info');
            if (info) info.innerHTML = '';
        }
    }

    function flujocaja_before_submit(form){
        if (maybeCheckInsufficientAndFocus(form)) {
            return false;
        }

        // Normalize monto and tasa fields so server receives "." as decimal separator and no thousands
        var montoInput = form.querySelector('input[name="monto"]');
        if (montoInput){
            var u = fcj_unformat(montoInput.value);
            montoInput.value = u; // normalized string like 1234.56 or empty
        }
        var tasa = form.querySelector('input[name="tasa"]');
        if (tasa) {
            var tu = fcj_unformat(tasa.value);
            tasa.value = tu;
        }

        // If we are in edit mode (form_id has value), ensure submit button uses guardar_edicion
        var idval = document.getElementById('form_id').value;
        var submitBtn = document.getElementById('submit_btn');
        if (idval && submitBtn) {
            submitBtn.name = 'guardar_edicion';
        } else if (submitBtn) {
            submitBtn.name = 'guardar';
        }
        return true;
    }
    </script>
</body>
</html>